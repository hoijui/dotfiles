function escape_javascript_string($str) {
  $map = [
          1,1,1,1,1,1,1,1,1,1,
          1,1,1,1,1,1,1,1,1,1,
          1,1,1,1,1,1,1,1,1,1,
          1,1,1,1,1,1,1,1,1,1,
          1,1,1,1,1,1,1,1,0,0, // 49
          0,0,0,0,0,0,0,0,1,1,
          1,1,1,1,1,0,0,0,0,0,
          0,0,0,0,0,0,0,0,0,0,
          0,0,0,0,0,0,0,0,0,0,
          0,1,1,1,1,1,1,0,0,0, // 99
          0,0,0,0,0,0,0,0,0,0,
          0,0,0,0,0,0,0,0,0,0,
          0,0,0,1,1,1,1,1,1,1,
          1,1,1,1,1,1,1,1,1,1,
          1,1,1,1,1,1,1,1,1,1, // 149
          1,1,1,1,1,1,1,1,1,1,
          1,1,1,1,1,1,1,1,1,1,
          1,1,1,1,1,1,1,1,1,1,
          1,1,1,1,1,1,1,1,1,1,
          1,1,1,1,1,1,1,1,1,1, // 199
          1,1,1,1,1,1,1,1,1,1,
          1,1,1,1,1,1,1,1,1,1,
          1,1,1,1,1,1,1,1,1,1,
          1,1,1,1,1,1,1,1,1,1,
          1,1,1,1,1,1,1,1,1,1, // 249
          1,1,1,1,1,1,1, // 255
          ];

  $mblen = mb_strlen($str, 'UTF-8');
  $utf32 = mb_convert_encoding($str, 'UTF-32', 'UTF-8');
  $convmap = [ 0x0, 0xffffff, 0, 0xffffff ];
  for ($i=0, $encoded=''; $i < $mblen; $i++) {
    $c =  (ord($utf32[$i*4+1]) << 16 ) + (ord($utf32[$i*4+2]) << 8) + ord($utf32[$i*4+3]);
    if ($c < 256 && $map[$c]) {
      if ($c < 10) {
        $encoded .= '\\x0'.base_convert($c, 10, 16);
      } else {
        $encoded .= '\\x'.base_convert($c, 10, 16);
      }
    } else if ($c == 2028) {
      $encoded .= '\\u2028';
    } else if ($c == 2029) {
      $encoded .= '\\u2029';
    } else {
      $encoded .= mb_decode_numericentity('&#'.$c.';', $convmap, 'UTF-8');
    }
  }
  return $encoded;
}
